!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="e72ab8ec-b43b-4fbd-96a1-3aa3cc6d289b",e._sentryDebugIdIdentifier="sentry-dbid-e72ab8ec-b43b-4fbd-96a1-3aa3cc6d289b")}catch(e){}}();"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3933],{59587:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.BufferController=void 0;var i=r(22970),n=r(69964),a=r(1319),o=r(19603),s=r(30020),d=r(67503),l=r(67179),u=r(64215),c=r(31246),h=r(84639),f=r(76018),p=r(47632),_=r(98669),v=r(54459),g=r(18233),m=r(94306),y=r(6246),E=r(28161),w=r(15302),S=r(16471),C=r(54965),b=r(41746),P=r(48360),R=r(88616),D=r(34518),V=r(11601),F=r(27574),B=r(34855),U=r(66124),M=r(43162),T=r(58269),A=r(65533),I=r(88309),x=r(16e3),k=r(29368),W=r(91689),O=r(36630),H=r(28521),G=r(57665),L=function(){function e(e,t,r,i,a,s,d,u){var h,_=this;void 0===i&&(i=[]),this.onError=new p.Emitter,this.onWarning=new p.Emitter,this.onBufferItemPhaseChange=new p.Emitter,this.onTextChange=new p.Emitter,this.onContentRangeChange=new p.Emitter,this.onSegmentDurationChanged=new p.Emitter,this.onBufferCapacityChanged=new p.Emitter,this.onBufferLevelChanged=new p.Emitter,this.onSegmentRetry=new p.Emitter,this._playerUtil=new F.PlayerUtil,this._codecUtil=new l.CodecUtil,this._mimeUtil=new P.MimeUtil,this._timeRangeUtil=new k.TimeRangeUtil,this._pipelineUtil=new A.SegmentPipelineWorkerUtil,this._variantUtil=new O.VariantUtil,this._variantFilters=[],this._trackPreferences=[],this._bufferItemMap=new C.Map,this._filteredVariantMap=new C.Map,this._selectedVariants=new C.Map,this._selectedVariantMap=new C.Map,this._bufferRegions=[],this._appendRegions=[],this._isBufferUpdateRunning=!1,this._isBufferUpdatePending=!1,this._requiresBufferUpdate=!1,this._textEnabled=!1,this._arrayUtil=new n.ArrayUtil,this._system=e,this._periods=t,this.metricBus=r,this._noAudio=null!==(h=null==s?void 0:s.noAudio)&&void 0!==h&&h,this._delayedHydrate=d,this._variantSelector=a,this._cmcd=u,this.mediaSourceController=new E.MediaSourceController(e),this.bufferLogic=new c.DefaultBufferLogic,this._retryHandler=new o.BufferRetryHandler(this._system,{getBufferItem:function(e){return _._bufferItemMap.tryGet(e)},getVariants:function(e){return _._selectedVariants.get(e)}}),this.mediaSourceController.onTextChange.on(this,function(e){return _.onTextChange.emit(e)}),this.mediaSourceController.onWarning.on(this,function(e){return _.onWarning.emit(e)}),this._trackPreferences=i,this.addVariantFilter(new x.SupportedVariantFilter(e)),this.addVariantFilter(new f.DigitalRightsVariantFilter(this)),this.addVariantFilter(new W.TrackPreferenceVariantFilter)}return e.clearDrainDataForStreamType=function(e,t){var r=e.mediaSourceDrain.tryGet(t);if(void 0!==r){T.SegmentPipeline.cleanDrained(r);for(var i=0;i<r.length;i++){var n=r[i];e.bufferControllerDrain.delete(n.state),e.retryHandlerDrain.delete(n.state)}e.mediaSourceDrain.delete(t)}},Object.defineProperty(e.prototype,"_framerateVariantFilter",{get:function(){var e=this._arrayUtil.find(this._variantFilters,function(e){return"Framerate Variant Filter"===e.id});if(e instanceof g.FramerateVariantFilter)return e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"drm",{get:function(){return this._drm},enumerable:!1,configurable:!0}),e.prototype.overrideDefaultRetryLogic=function(e){this._retryHandler.overrideDefaultRetryLogic(e)},e.prototype.attach=function(e){return i.__awaiter(this,void 0,void 0,function(){var t;return i.__generator(this,function(r){switch(r.label){case 0:return[4,this.mediaSourceController.attach(e)];case 1:if(r.sent(),!(void 0!==(t=this._lastContentRange)))return[3,3];return[4,e.setContentRange(t.start,t.end)];case 2:r.sent(),r.label=3;case 3:return[2]}})})},e.prototype.detach=function(){this._mediaKeyPromise=void 0,this._selectedVariantMap.clear(),this._selectedVariants.clear(),this._filteredVariantMap.clear(),this._textEnabled=!1,this._lastContentRange=void 0,this._choosePipelinesPromise=void 0,void 0!==this._delayedHydrate&&(E.MediaSourceController.cleanDrained(this._delayedHydrate.mediaSourceDrain),this._delayedHydrate=void 0),this.mediaSourceController.detach()},e.prototype.destroy=function(){var e;return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(t){switch(t.label){case 0:return this.detach(),this.onError.off(),this.onWarning.off(),this.onBufferItemPhaseChange.off(),this.onTextChange.off(),this.onContentRangeChange.off(),this.mediaSourceController.destroy(),this._bufferItemMap.clear(),this._filteredVariantMap.clear(),this._selectedVariantMap.clear(),this._selectedVariants.clear(),this._retryHandler.clear(),this.clearVariantFilters(),this._periods=[],this.mediaSourceController.onTextChange.off(this),this.mediaSourceController.onWarning.off(this),this.setAppendRegions([]),this.setBufferRegions([]),this._removeOutsideOfRange(),[4,null===(e=this.drm)||void 0===e?void 0:e.destroy()];case 1:return t.sent(),[2]}})})},e.getVariantFilterPriority=function(e){var t,r;return null!==(r=((t={})["Supported Variant Filter"]=0,t["Digital Rights Variant Filter"]=1,t["Track Preference Variant Filter"]=2,t["Codec Group Variant Filter"]=3,t.VideoSizeVariantFilter=4,t["Framerate Variant Filter"]=5,t)[e])&&void 0!==r?r:9999},e.prototype.needsBufferUpdate=function(e){return this._requiresBufferUpdate||!this.hasFilteredVariants(e)},e.prototype.requireBufferUpdate=function(){this._requiresBufferUpdate=!0,this._isBufferUpdateRunning&&(this._isBufferUpdatePending=!0)},e.prototype.hasFilteredVariants=function(e){var t=this._filteredVariantMap.tryGet(e);return void 0!==t&&this._variantFilters.every(function(e){return e.id in t})},e.prototype.invalidateVariants=function(e,t){if(t.length>0){var r=this._filteredVariantMap.tryGet(e);if(void 0!==r)for(var i=0;i<t.length;i++){var n=t[i];delete r[n]}}else this._filteredVariantMap.delete(e)},e.prototype.invalidateAllVariants=function(e){var t=this;void 0===e&&(e=[]),e.length>0?this._filteredVariantMap.forEach(function(r){t.invalidateVariants(r,e)}):this._filteredVariantMap.clear()},e.prototype.clearAsync=function(e){return i.__awaiter(this,void 0,void 0,function(){var t,r,n,a,o;return i.__generator(this,function(i){switch(i.label){case 0:for(n=0,t=this.mediaSourceController.getPipelines(),r=[],a=t;n<a.length;n++)o=a[n],(void 0===e||o.type===e)&&r.push(o.clearAsync());return[4,Promise.all(r)];case 1:return i.sent(),this.requireBufferUpdate(),[2]}})})},e.prototype.drainDownloaded=function(){var e=this,t=new C.Map,r=this.mediaSourceController.drainDownloaded(),i=this._retryHandler.retryData;return r.forEach(function(r,i){for(var n=0;n<i.length;n++){var a=i[n],o=e._bufferItemMap.get(a.state);t.set(a.state,{pipelineState:o.pipelineState,stream:o.stream,variant:o.variant,period:o.period,blockedSegmentIds:o.blockedSegmentIds}),e._bufferItemMap.delete(a.state)}}),{mediaSourceDrain:r,bufferControllerDrain:t,retryHandlerDrain:i}},e.prototype.getTrackPreferences=function(){return this._trackPreferences},e.prototype.setAppendPeriod=function(e){this._appendPeriod!==e&&(this._appendPeriod=e,this.bufferLogic.applyToPipelines(this))},e.prototype.setTextEnabled=function(e){void 0===e&&(e=!0),this._textEnabled=e,this.mediaSourceController.setTextEnabled(e)},e.prototype.setTrackPreferences=function(t){return i.__awaiter(this,void 0,void 0,function(){var r,n,a,o,s,d,l;return i.__generator(this,function(i){switch(i.label){case 0:for(r=this._trackPreferences,this._trackPreferences=t,this._system.logVerbose("Invalidating filtered variants due to track preference changes"),this.invalidateAllVariants(["Track Preference Variant Filter"]),n=new m.HashMap,a=new m.HashMap,r.forEach(function(e){n.contains(e.streamType)||n.set(e.streamType,[]),n.get(e.streamType).push(e)}),t.forEach(function(e){a.contains(e.streamType)||a.set(e.streamType,[]),a.get(e.streamType).push(e)}),o=[],s=0,d=["video","audio","text"];s<d.length;s++)l=d[s],(n.contains(l)||a.contains(l))&&(n.contains(l)&&a.contains(l)&&this._playerUtil.isTrackPreferencesEqual(n.get(l),a.get(l))||(o.push(this.clearAsync(l)),void 0!==this._delayedHydrate&&e.clearDrainDataForStreamType(this._delayedHydrate,l)));if(!(o.length>0))return[3,2];return[4,Promise.all(o)];case 1:return i.sent(),[2,this.updateBufferRegions()];case 2:return[2]}})})},e.prototype.isSegmentUsable=function(e){if(void 0===this.drm)return!0;var t=!0;return void 0!==e.segment.keyId&&e.segment.keyId.length>0&&(t=this.drm.isUsable([e.segment.keyId])),t},e.prototype.isSegmentAppendable=function(e){var t=this._bufferItemMap.tryGet(e);return(null==t?void 0:t.period)===this._appendPeriod},e.prototype.getBufferItem=function(e){return this._bufferItemMap.tryGet(e)},e.prototype.getActivePipelines=function(){return this.mediaSourceController.getPipelines()},e.prototype.getPeriods=function(){return this._periods},e.prototype.getBufferRegions=function(){return this._bufferRegions},e.prototype.getAppendRegions=function(){return this._appendRegions},e.prototype.getReadyRegions=function(){for(var e=[],t=0,r=this._periods;t<r.length;t++){var i=r[t],n=this._playerUtil.getRangeOfPeriod(i);if(void 0!==this._selectedVariantMap.tryGet(i)&&void 0!==n){var a=new y.HashSet,o=this._selectedVariantMap.get(i);void 0!==o.video&&a.add("video"),void 0!==o.audio&&a.add("audio"),void 0!==o.text&&a.add("text"),e.push.apply(e,this.mediaSourceController.getReadyRegions([n],a))}}return this._timeRangeUtil.merge(e)},e.prototype.getContentRange=function(){return this._lastContentRange},e.prototype.getBufferItems=function(e){for(var t=[],r=this.mediaSourceController.getPipelineItems(e),i=0;i<r.length;i++){var n=r[i];t.push(this._bufferItemMap.get(n))}return t},e.prototype.setBufferRegions=function(e){this._bufferRegions=e},e.prototype.setAppendRegions=function(e){this._appendRegions=e},Object.defineProperty(e.prototype,"bandwidths",{get:function(){return void 0===this._variantDetails?[]:this._variantDetails.toArray().map(function(e){return e.bandwidth})},enumerable:!1,configurable:!0}),e.prototype.updateBufferRegions=function(){var e;return i.__awaiter(this,void 0,void 0,function(){var t,r,n,a,o,d,l,u,c,h,f,p,_,g=this;return i.__generator(this,function(i){switch(i.label){case 0:if(this._isBufferUpdateRunning)return this._isBufferUpdatePending=!0,[2];this._isBufferUpdateRunning=!0,i.label=1;case 1:return i.trys.push([1,10,,11]),this._removeOutsideOfRange(),[4,this._preBufferRegionUpdate()];case 2:for(i.sent(),r=[],n=0,a=this._periods;n<a.length;n++)o=a[n],(void 0===(d=this._playerUtil.getRangeOfPeriod(o))||this._timeRangeUtil.contains(this._bufferRegions,[d]))&&r.push(o);if(!(r.length>0))return[3,4];return void 0===this._choosePipelinesPromise&&(this._choosePipelinesPromise=this._chooseStreamPipelines(null!==(e=this._appendPeriod)&&void 0!==e?e:r[0])),[4,this._choosePipelinesPromise];case 3:i.sent(),i.label=4;case 4:return[4,Promise.all(r.map(function(e){return g._updatePeriodBufferRegions(e)}))];case 5:if(!i.sent().every(function(e){return e}))return[3,7];return[4,this._updateContentRange()];case 6:for(i.sent(),this.bufferLogic.applyToPipelines(this),l=this.mediaSourceController.getPipelines(),u=0,c=l;u<c.length;u++)c[u].flush();i.label=7;case 7:if(h=this._calculateBufferCapacitySec(),this._currentBufferCapacitySec!==h&&(this._currentBufferCapacitySec=h,this.onBufferCapacityChanged.emit(this._currentBufferCapacitySec)),f=new I.Set,p=[],this._bufferItemMap.forEach(function(e,t){f.has(t.stream)||(f.add(t.stream),p.push(g._applyDrmFromStream(t.period,t.stream)))}),!(p.length>0))return[3,9];return[4,Promise.all(p)];case 8:i.sent(),i.label=9;case 9:return[3,11];case 10:return(_=i.sent())instanceof G.WrappedError&&G.WrappedError.causedBy(_,D.OperationCanceledError.NAME)?this.onWarning.emit(new H.WarningError("ignoring operation canceled",_)):t=new s.BufferUpdateError("Failed to apply periods to pipelines",G.WrappedError.wrap(_,"BufferRegionError")),[3,11];case 11:if(this._isBufferUpdateRunning=!1,this._requiresBufferUpdate=!1,void 0!==t){if(this._isBufferUpdatePending=!1,G.WrappedError.causedBy(t,v.FormatChangedError.NAME)||G.WrappedError.causedBy(t,b.MediaKeySessionGenerateRequestError.NAME))return this.onError.emit(t),[2];throw t}if(!this._isBufferUpdatePending)return[3,13];return this._isBufferUpdatePending=!1,[4,this.updateBufferRegions()];case 12:i.sent(),i.label=13;case 13:return[2]}})})},e.prototype._chooseStreamPipelines=function(e){var t;return i.__awaiter(this,void 0,void 0,function(){var r,n,a,o;return i.__generator(this,function(i){switch(i.label){case 0:return[4,this._selectVariant(e)];case 1:return[4,null===(t=(r=i.sent()).currentSelection)||void 0===t?void 0:t.getDetails()];case 2:if(void 0===(a=i.sent()))return[2];return o=[],this._noAudio||void 0===a.audioDetails||o.push(this._ensurePipelineForStream(a.audioDetails,a,r)),void 0!==a.videoDetails&&o.push(this._ensurePipelineForStream(a.videoDetails,a,r)),n=void 0!==a.textDetails?this._ensurePipelineForStream(a.textDetails,a,r):this._ensureTextPipeline(),o.push(n),[4,Promise.all(o)];case 3:return i.sent(),void 0!==this._delayedHydrate&&(this._fillFromDrain(this._delayedHydrate),this._delayedHydrate=void 0),[2]}})})},e.prototype._fillFromDrain=function(e){for(var t,r=this.mediaSourceController.getPipelines(),n=0;n<r.length;n++){var a=r[n],o=e.mediaSourceDrain.tryGet(a.type);if(void 0!==o){a.fillFromDrain(o);for(var s=0;s<o.length;s++){var d=o[s],l=e.bufferControllerDrain.tryGet(d.state);void 0!==l&&(null===(t=this.drm)||void 0===t||t.prepare(l.period,l.stream),this._bufferItemMap.set(d.state,i.__assign(i.__assign({},l),{pipeline:a})))}}}this._retryHandler.retryData=e.retryHandlerDrain},e.prototype._onAttachPipeline=function(e){var t=this;e.onPipelinePhaseChanged.on(this,function(r){if(!t._bufferItemMap.contains(r)){t.onError.emit(new w.InvalidOperationError("Unexpected state change for unknown buffer item at t=".concat(r.start,"-").concat(r.end)));return}var i=r.phases.getLastPhaseName();if("video"===e.type&&("DownloadCompleted"===i||"RemoveCompleted"===i)){if(void 0===t._segmentDurationSec){var n=t._calculateSegmentDurationSec();void 0!==n&&0!==n&&(t._segmentDurationSec=n,t.onSegmentDurationChanged.emit(n))}var a=t._calculateCurrentBufferLevelSec();t._currentBufferLevelSec!==a&&(t._currentBufferLevelSec=a,t.onBufferLevelChanged.emit(t._currentBufferLevelSec))}var o=t._bufferItemMap.get(r);t.onBufferItemPhaseChange.emit(o),"DownloadQueued"===i?r.downloadStartTimesMS.push(Date.now()):"DownloadCompleted"===i?B.PromiseUtil.catchRejection(function(){return t.updateBufferRegions()},function(e){t.onError.emit(G.WrappedError.wrap(e))}):"AppendCompleted"===i?B.PromiseUtil.catchRejection(function(){return t.updateBufferRegions()},function(e){t.onError.emit(G.WrappedError.wrap(e))}):"RemoveCompleted"===i&&(t._bufferItemMap.delete(r),t._retryHandler.delete(r))}),e.onError.on(this,function(r){B.PromiseUtil.catchRejection(function(){return i.__awaiter(t,void 0,void 0,function(){var t,n;return i.__generator(this,function(i){switch(i.label){case 0:if(!G.WrappedError.causedBy(r.error,R.OfflineError.NAME))return[3,2];return[4,this._resetPipelineStateAndRetry(r)];case 1:return i.sent(),[3,12];case 2:if(!G.WrappedError.causedBy(r.error,M.SegmentDownloadFailedError.NAME))return[3,9];this.onSegmentRetry.emit(),t=void 0,i.label=3;case 3:return i.trys.push([3,5,,6]),[4,this._retryHandler.onSegmentDownloadFailed(r)];case 4:return t=i.sent(),[3,6];case 5:return n=i.sent(),this.onError.emit(G.WrappedError.wrap(n)),[3,6];case 6:if(!0!==t)return[3,8];return[4,this.updateBufferRegions()];case 7:i.sent(),i.label=8;case 8:return[3,12];case 9:if(!G.WrappedError.causedBy(r.error,U.QuotaExceededError.NAME))return[3,11];return[4,this._onQuotaExceeded(e,r)];case 10:return i.sent(),[3,12];case 11:G.WrappedError.causedBy(r.error,D.OperationCanceledError.NAME)||this.onError.emit(new a.BufferError(this._bufferItemMap.get(r))),i.label=12;case 12:return[2]}})})},function(e){return t.onError.emit(G.WrappedError.wrap(e))})}),e.onWarning.on(this,function(e){return t.onWarning.emit(e)})},e.prototype._onQuotaExceeded=function(e,t){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(e){switch(e.label){case 0:return this.onWarning.emit(new H.WarningError(U.QuotaExceededError.NAME,t.error)),[4,this._resetPipelineStateAndRetry(t)];case 1:return e.sent(),[2]}})})},e.prototype._resetPipelineState=function(e){e.phases.reset(),e.processing=!1,e.error=void 0},e.prototype._resetPipelineStateAndRetry=function(e){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(t){switch(t.label){case 0:return this._resetPipelineState(e),[4,this.updateBufferRegions()];case 1:return t.sent(),[2]}})})},e.prototype._onDetachPipeline=function(e){e.onPipelinePhaseChanged.off(this),e.onError.off(this),e.onWarning.off(this)},e.prototype._ensureTextPipeline=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){return e={mimeType:u.ContainerConstants.DEFAULT_TEXT_MIME_TYPE,attributes:0,codecs:u.ContainerConstants.DEFAULT_TEXT_CODECS},[2,this._ensurePipeline(e,"text")]})})},e.prototype._ensurePipelineForStream=function(e,t,r){return i.__awaiter(this,void 0,void 0,function(){var n;return i.__generator(this,function(i){return n={mimeType:e.mimeType,attributes:e.attributes,codecs:this._getCodecs(e.type,t,r)},[2,this._ensurePipeline(n,e.type,e)]})})},e.prototype._ensurePipeline=function(e,t,r){var n,a;return i.__awaiter(this,void 0,void 0,function(){var o,s,d;return i.__generator(this,function(i){switch(i.label){case 0:if(void 0!==(o=this.mediaSourceController.getPipeline(t)))return[3,2];return s=void 0!==r?this._mimeUtil.getExtendedType(r):this._mimeUtil.getFullType(e.mimeType,e.codecs),d=(null!==(a=null===(n=null==r?void 0:r.embeddedCaptions)||void 0===n?void 0:n.length)&&void 0!==a?a:0)>0,this._system.logInfo("Creating ".concat(t," pipeline with stream '").concat(s,"', extractEmbeddedCaptions=").concat(d)),[4,this.mediaSourceController.makePipeline(t,e,d,this._cmcd)];case 1:o=i.sent(),this._onAttachPipeline(o),i.label=2;case 2:return[2,o]}})})},e.prototype._calculateSegmentDurationSec=function(){for(var e=this.getActivePipelines().filter(function(e){return"video"===e.type}),t=0;t<e.length;t++)for(var r=e[t].active.getAllRanges(),i=0;i<r.length;i++){var n=r[i],a=n.end-n.start;if(!(a<=0))return a;throw new S.InvalidSegmentDurationError("Invalid segment duration detected, cannot calculate buffer thresholds.")}},e.prototype._calculateBufferCapacitySec=function(){var e=this.getContentRange();return void 0===e&&(e={start:0,end:1/0}),this._timeRangeUtil.getSumOfIntersection(e,this.getBufferRegions())},e.prototype._calculateCurrentBufferLevelSec=function(){var e=0,t=this.mediaSourceController.getPipeline("video");if(void 0!==t)for(var r=t.active.getAllRanges(),i=0;i<r.length;i++){var n=r[i];this._pipelineUtil.isDownloaded(n)&&(e+=n.end-n.start)}return e},e.prototype._addBufferItem=function(e,t,r,i,n){var a={pipelineState:r,stream:i,variant:n,pipeline:e,period:t,blockedSegmentIds:new y.HashSet};return this._bufferItemMap.set(r,a),a},e.prototype._applyDrmFromStream=function(e,t){var r;return void 0!==this.drm&&(this.drm.prepare(e,t),("single_period_existing_drm"===this._system.requiredMultiPeriodWorkaround()||e===this._appendPeriod)&&(r=this.drm.apply(t))),r},e.prototype._applyStreamToPipeline=function(e,t,r,n,a){if(this._playerUtil.isEmptyStream(r)){this._system.logWarn("Found empty stream, skipping.");return}var o=this._applyDrmFromStream(t,r);if(0===this._bufferRegions.length)return o;for(var s=this._playerUtil.getSegmentIndicesInRange(r.segments,this._bufferRegions[0]),d=e.active.first(),l=!0,u=s.startIndex;u<s.endIndexExclusive;u++){var c=r.segments.getSegment(u);if(this._timeRangeUtil.contains(this._bufferRegions,[c])){l&&void 0!==d&&!this._timeRangeUtil.isTimeClose(c.start,d.start)&&c.start<d.start&&e.removeAll(),l=!1;var h=this._applySegmentToPipeline(e,c,i.__assign(i.__assign({},a),{nextSegment:r.segments.tryGetSegment(u+1)}));void 0!==h&&this._addBufferItem(e,t,h,r,n)}}return o},e.prototype._applySegmentToPipeline=function(e,t,r){var i=this,n={start:t.start,end:t.end},a=e.active.getInside([n]),o=a;if(0===(o=a.filter(function(e){return i._timeRangeUtil.hasIntersect(e,t,k.TimeRangeUtil.DEFAULT_INTERSECT_PERCENT)})).length){if(0!==a.length&&this.onWarning.emit(new H.WarningError("Adding segment with overlap existing has t=(".concat(a[0].start,"-").concat(a[0].end,") and adding t=(").concat(t.start,"-").concat(t.end,") for ").concat(t.createUri," with ").concat(t.originalStart,"-").concat(t.originalEnd))),""===t.createUri)throw new s.BufferUpdateError("attempting to add a segment without known create uris to pipeline at ".concat(t.start,"-").concat(t.end));return e.add(t,r,{allowAppend:!1,allowDownload:!1,timeoutMS:this._retryHandler.timeoutMS,progressTimeoutMS:this._retryHandler.progressTimeoutMS})}if(1===o.length){var d=o[0],l=this._bufferItemMap.tryGet(d);if(d.segment.id!==t.id&&!this._pipelineUtil.isDownloaded(d)&&!this._pipelineUtil.isDownloading(d)&&(void 0===l||!l.blockedSegmentIds.has(t.id)))return d.segment=t,d.context=r,d}else throw new s.BufferUpdateError("Unexpected number of matching segments ".concat(o.length))},e.prototype._updatePeriodBufferRegions=function(e){var t,r,n;return i.__awaiter(this,void 0,void 0,function(){var a,o,l,u,c,h,f,p,_,g,m,y,E,w,S;return i.__generator(this,function(i){switch(i.label){case 0:return[4,this._selectVariant(e)];case 1:return[4,null===(t=(a=i.sent()).currentSelection)||void 0===t?void 0:t.getDetails()];case 2:if(o=i.sent(),void 0===a.currentSelection||void 0===o)throw new d.BufferVariantError(a);if(this._isBufferUpdatePending)return[2,!1];if(e===this._appendPeriod){for(l=0,u=[o.audio,o.video,o.text];l<u.length;l++)if(void 0!==(c=u[l])&&void 0!==(h=this._getCurrentStreamCodecGroup(c.type))&&(f=this._getCodecs(c.type,a.currentSelection,a),p=this._getStreamCodecGroup(c,f),!this._codecUtil.isCodecGroupCompatible(p,h)))throw new v.FormatChangedError(h,p)}for(this._selectedVariantMap.set(e,o),_=[],void 0!==o.videoDetails&&_.push(o.videoDetails),this._noAudio||void 0===o.audioDetails||_.push(o.audioDetails),this._textEnabled&&void 0!==o.textDetails&&_.push(o.textDetails),g=[],m=0,y=_;m<y.length;m++){if(E=y[m],void 0===(w=this.mediaSourceController.getPipeline(E.type)))throw new s.BufferUpdateError("Did not find existing pipeline for stream type ".concat(E.type));S=this._applyStreamToPipeline(w,e,E,o,{bandwidthEstimateBps:a.currentBandwidthEstimateBps,bufferCapacitySec:a.currentBufferCapacitySec,topBitrateBps:"image"!==E.type?null===(n=null===(r=a.currentTopBitrateVariant)||void 0===r?void 0:r[E.type])||void 0===n?void 0:n.bandwidth:void 0,encodedBitrateBps:E.bandwidth}),g.push(S)}return[4,Promise.all(g)];case 3:return i.sent(),[2,!0]}})})},e.prototype._selectVariant=function(e){var t,r,n,a;return i.__awaiter(this,void 0,void 0,function(){var o,s,d,l,u,c,h,f;return i.__generator(this,function(i){switch(i.label){case 0:return[4,this._selectVariantMetadata(e)];case 1:o=i.sent(),s=new I.Set,i.label=2;case 2:if(!(void 0!==o.currentSelection)||s.has(o.currentSelection))return[3,7];return s.add(o.currentSelection),d=null===(t=o.currentSelection.audio)||void 0===t?void 0:t.getCachedDetails(),l=null===(r=o.currentSelection.video)||void 0===r?void 0:r.getCachedDetails(),u=null===(n=o.currentSelection.text)||void 0===n?void 0:n.getCachedDetails(),[4,o.currentSelection.getDetails()];case 3:if(c=i.sent(),h=[],(void 0===d&&void 0!==c.audioDetails||void 0===l&&void 0!==c.videoDetails||void 0===u&&void 0!==c.textDetails)&&h.push("Digital Rights Variant Filter"),this._system.requireSingleFramerate()&&void 0===this._framerateVariantFilter&&void 0===l&&(null===(a=c.videoDetails)||void 0===a?void 0:a.frameRate)!==void 0&&(f=new g.FramerateVariantFilter,this.addVariantFilter(f),this._system.logVerbose("Locking framerate to ".concat(c.videoDetails.frameRate,"fps.")),h.push("Framerate Variant Filter"),f.setVideoFramerate(c.videoDetails.frameRate)),!(h.length>0))return[3,5];return this._system.logVerbose("Invalidating specific period filters due to new variant details:",h),this.invalidateVariants(e,h),[4,this._selectVariantMetadata(e)];case 4:return o=i.sent(),[3,6];case 5:return[3,7];case 6:return[3,2];case 7:return void 0!==o.currentSelection&&this._validatePeriodRangeWithVariant(e,o.currentSelection),[2,o]}})})},e.prototype._preBufferRegionUpdate=function(){return void 0===this._mediaKeyPromise&&(this._mediaKeyPromise=this._ensureMediaKeys()),this._mediaKeyPromise},e.prototype._selectVariantMetadata=function(t){var r,n;return i.__awaiter(this,void 0,void 0,function(){var a,o,s,d,l,u,c,h,f,p,_;return i.__generator(this,function(v){switch(v.label){case 0:return a=this._makePreferences(),o=this._selectedVariantMap.tryGet(t),s=new m.HashMap,(d=new m.HashMap).set(e.INITIAL_NAME,this._getCodecGroups(t)),l={period:t,audio:t.audio,video:t.video,text:t.text,trackPreferences:a,previousSelection:o,filterMap:s,filterCodecMap:d},[4,this._filterVariantContext(l)];case 1:return v.sent(),!0!==l.hadFilterChange&&this._selectedVariants.contains(t)||(u=this._variantUtil.createSortedVariantListFromStreamCollection(l),this._arrayUtil.areEqual(u.toArray(),null!==(n=null===(r=this._variantDetails)||void 0===r?void 0:r.toArray())&&void 0!==n?n:[])||(this._variantDetails=u,this.metricBus.bandwidthsChange.emit(this.bandwidths)),this._selectedVariants.set(t,u)),c=this._selectedVariants.get(t),h=this._variantSelector.getVariant(c),f=this._variantSelector.getTopBitrateVariant(c),p=this._variantSelector.getCurrentBandwidthEstimate(),_=this._calculateBufferCapacitySec(),[2,i.__assign(i.__assign({},l),{currentSelection:h,currentTopBitrateVariant:f,currentBandwidthEstimateBps:p>0?p:void 0,currentBufferCapacitySec:_>0?_:void 0})]}})})},e.prototype._throwFilteredToZeroError=function(e,t,r,i){var n="Period ".concat(r,": '").concat(e.id,"' reduced ").concat(t," to zero, there are no variants left to play!");n+="\nCodec Group Contextual Info:\n"+this._getCodecMapFilterString(i).split("\n").map(function(e){return"    ".concat(e)}).join("\n"),void 0!==e.getContextualInfo&&(n+="\nFilter Contextual Info:\n"+e.getContextualInfo(this._system).split("\n").map(function(e){return"    ".concat(e)}).join("\n"));var a=this._getVariantFilterErrorByType(e.id,n);if(void 0!==e.getFilterError)throw e.getFilterError(i,a);throw a},e.prototype._getVariantFilterErrorByType=function(e,t){var r=Error(t);return"Digital Rights Variant Filter"===e?new h.DigitalRightsError(r):r},e.prototype._getCodecMapFilterString=function(e){var t=[];return e.filterCodecMap.forEach(function(e,r){var i=[];r.forEach(function(e){i.push(e)}),t.push("".concat(e,": ").concat(i.join(",")))}),"".concat(t.join("\n"))},e.prototype._filterVariantContext=function(e){var t;return i.__awaiter(this,void 0,void 0,function(){var r,n,a,o,s,d,l,u,c,h,f;return i.__generator(this,function(i){switch(i.label){case 0:r=e.period,n=null!==(t=this._filteredVariantMap.tryGet(r))&&void 0!==t?t:{},e.hadFilterChange=!1,a=0,o=this._variantFilters,i.label=1;case 1:if(!(a<o.length))return[3,7];if(s=o[a],!(!e.hadFilterChange&&s.id in n))return[3,2];return e.audio=n[s.id].audio,e.video=n[s.id].video,e.text=n[s.id].text,[3,5];case 2:if(d=e.audio.length+e.video.length+e.text.length,l=new Date().getTime(),c=(u=s.filterVariants(e))instanceof Promise,!(u instanceof Promise))return[3,4];return[4,u];case 3:u=i.sent(),i.label=4;case 4:(h=u.audio.length+u.video.length+u.text.length)!==d&&(f="Period ".concat(r.id,": '").concat(s.id,"' reduced variants from ").concat(d," to ").concat(h),c||(f+=" in ".concat(new Date().getTime()-l)),this._system.logVerbose(f),e.audio=u.audio,e.video=u.video,e.text=u.text,0===e.audio.length&&this._throwFilteredToZeroError(s,"audio",r.id,e),0===e.video.length&&this._throwFilteredToZeroError(s,"video",r.id,e)),n[s.id]={audio:e.audio,video:e.video,text:e.text},e.hadFilterChange=!0,i.label=5;case 5:e.filterCodecMap.set(s.id,this._getCodecGroups(e)),e.filterMap.set(s.id,e.audio.length+e.video.length+e.text.length),i.label=6;case 6:return a++,[3,1];case 7:return this._filteredVariantMap.set(r,n),[2]}})})},e.prototype._makePreferences=function(){var t=this._trackPreferences.slice(),r=new y.HashSet(t.map(function(e){return e.streamType}));return r.has("audio")||t.push(e.DEFAULT_AUDIO_PREFERENCE),r.has("video")||t.push(e.DEFAULT_VIDEO_PREFERENCE),r.has("text")||t.push(e.DEFAULT_TEXT_PREFERENCE),t},e.prototype._getCodecGroups=function(e){for(var t=new y.HashSet,r=0,n=i.__spreadArray(i.__spreadArray([],e.audio,!0),e.video,!0);r<n.length;r++){var a=n[r];t.add(this._codecUtil.getCodecGroup(a))}return t},e.prototype._getCodecs=function(e,t,r){return"audio"===e&&void 0!==t.audio?t.audio.codecs:"text"===e&&void 0!==t.text?t.text.codecs:"video"===e&&r.video.length>0?r.video[0].codecs:""},e.prototype._updateContentRange=function(){var e;return i.__awaiter(this,void 0,void 0,function(){var t,r,n;return i.__generator(this,function(i){switch(i.label){case 0:if(t=this._lastContentRange,r=this._playerUtil.getRangeOfPeriods(this._periods),this._lastContentRange=r,n=void 0===t&&void 0!==r||void 0!==t&&void 0===r,void 0!==t&&void 0!==r&&(n=t.start!==r.start||t.end!==r.end),!n)return[3,3];if(!(void 0!==r))return[3,2];return[4,null===(e=this.mediaSourceController.getMediaSource())||void 0===e?void 0:e.setContentRange(r.start,r.end)];case 1:i.sent(),i.label=2;case 2:this.onContentRangeChange.emit(r),i.label=3;case 3:return[2]}})})},e.prototype._removeOutsideOfRange=function(){for(var e=this,t=this._bufferRegions[0],r=this.mediaSourceController.getPipelines(),i=0;i<r.length;i++){var n=r[i];if(void 0===t){n.removeAll();continue}var a=n.active.getAllRanges().filter(function(t){return e._pipelineUtil.hasPhase(t,"AppendQueued")}),o=this._timeRangeUtil.getOutsideOf(a,this._bufferRegions);if(o.length>0&&o[o.length-1].end>=t.end)n.removeAll();else{for(var s=[],d=0,l=0,u=n.active.getAllRanges();l<u.length;l++){var c=u[l];!this._timeRangeUtil.hasOverlap(c,t)&&(s.push(c),c.start<t.start&&++d)}if(d>0){var h=d-1;t.start-s[h].end<1&&s.splice(h,1)}for(var f=0;f<s.length;f++){var p=s[f];n.remove(p)}}}},e.prototype._getCurrentStreamCodecGroup=function(e){var t=this.mediaSourceController.getPipeline(e);if(void 0!==t){var r=t.getSourceType();return void 0===r?void 0:this._codecUtil.getCodecGroup(r)}},e.prototype._getStreamCodecGroup=function(e,t){var r={mimeType:e.mimeType,attributes:e.attributes,codecs:t};return this._codecUtil.getCodecGroup(r)},e.prototype.addVariantFilter=function(t){var r,i=this;if(this._variantFilters.some(function(e){return e.id===t.id}))throw Error("addVariantFilter - variant filter id must be unique: ".concat(t.id));if(null===(r=t.onWarning)||void 0===r||r.on(this,function(e){return i.onWarning.emit(e)}),0===this._variantFilters.length)this._variantFilters.push(t);else{for(var n=e.getVariantFilterPriority(t.id),a=!1,o=0;o<this._variantFilters.length;o++){var s=this._variantFilters[o];if(e.getVariantFilterPriority(s.id)>n){this._variantFilters.splice(o,0,t),a=!0;break}}a||this._variantFilters.push(t)}},e.prototype.clearVariantFilters=function(){var e=this;this._variantFilters.forEach(function(t){var r;return null===(r=t.onWarning)||void 0===r?void 0:r.off(e)}),this._variantFilters=[]},e.prototype.removeVariantFilter=function(e){var t=this;this._variantFilters=this._variantFilters.filter(function(r){var i,n=r===e;return n&&(null===(i=r.onWarning)||void 0===i||i.off(t)),!n})},e.prototype.selectAllVariants=function(){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(e){switch(e.label){case 0:void 0===this._selectAllVariantsPromise&&(this._selectAllVariantsPromise=this._selectAllVariants()),e.label=1;case 1:return e.trys.push([1,,3,4]),[4,this._selectAllVariantsPromise];case 2:return[2,e.sent()];case 3:return this._selectAllVariantsPromise=void 0,[7];case 4:return[2]}})})},e.prototype.setPlayerVitals=function(e){var t;null===(t=this._drm)||void 0===t||t.setPlayerVitals(e)},e.prototype.removeDrm=function(){var e=this._drm;return this._removeDrmEvents(),this._drm=void 0,e},e.prototype.setDrm=function(e){this._removeDrmEvents(),this._drm=e,this._attachDrmEvents()},e.prototype.hasRestrictedSegments=function(){if(void 0===this.drm)return!1;for(var e=!1,t=0,r=this.getActivePipelines();t<r.length;t++){for(var i=r[t],n=[],a=0,o=i.active.getAllRanges();a<o.length;a++){var s=o[a];void 0!==s.segment.keyId&&-1===n.indexOf(s.segment.keyId)&&n.push(s.segment.keyId)}if(this.drm.isRestricted(n)){e=!0;break}}return e},e.prototype._removeDrmEvents=function(){void 0!==this.drm&&(this.drm.onUpdated.off(this),this.drm.onError.off(this),this.drm.onWarning.off(this),this.drm.onSingleKeyRestriction.off(this))},e.prototype._attachDrmEvents=function(){var e=this;void 0!==this.drm&&(this.drm.onUpdated.on(this,function(){B.PromiseUtil.catchRejection(function(){return i.__awaiter(e,void 0,void 0,function(){var e,t,r;return i.__generator(this,function(i){switch(i.label){case 0:e=null===(r=this.drm)||void 0===r?void 0:r.getStatusMap(),this._system.logVerbose("Invalidating filtered variants due DRM status change"),this.invalidateAllVariants(["Digital Rights Variant Filter"]);try{if(this._isEveryKeyStatus(e,"expired"))throw new _.ExpiredKeysError;if(this.hasRestrictedSegments())throw new V.OutputRestrictedError}catch(e){t=G.WrappedError.wrap(e)}if(!(void 0!==t))return[3,1];return this.onError.emit(t),[3,3];case 1:return[4,this.updateBufferRegions()];case 2:i.sent(),i.label=3;case 3:return[2]}})})},function(t){return e.onError.emit(G.WrappedError.wrap(t))})}),this.drm.onSingleKeyRestriction.on(this,function(t){for(var r=0;r<t.length;r++){var i=t[r];e._system.logVerbose("Invalidating period ".concat(i.period.id," variants due to single key restriction ").concat(i.key)),e.invalidateVariants(i.period,["Digital Rights Variant Filter"])}}),this.drm.onError.on(this,function(t){return e.onError.emit(t)}),this.drm.onWarning.on(this,function(t){return e.onWarning.emit(t)}))},e.prototype._isEveryKeyStatus=function(e,t){if(void 0===e||0===e.getCount())return!1;for(var r=0,i=e.values();r<i.length;r++)if(i[r].status!==t)return!1;return!0},e.prototype._selectAllVariants=function(){var e;return i.__awaiter(this,void 0,void 0,function(){var t,r,n,a,o,s,d,l,u;return i.__generator(this,function(i){switch(i.label){case 0:for(r=0,t=[],n=this.getPeriods();r<n.length;r++)a=n[r],t.push(this._selectVariant(a));return[4,Promise.all(t)];case 1:o=i.sent(),s=[],d=0,l=o,i.label=2;case 2:if(!(d<l.length))return[3,5];return[4,null===(e=l[d].currentSelection)||void 0===e?void 0:e.getDetails()];case 3:void 0!==(u=i.sent())&&s.push(u),i.label=4;case 4:return d++,[3,2];case 5:return[2,s]}})})},e.prototype._validatePeriodRangeWithVariant=function(t,r){var i=e.PERIOD_RANGE_MISMATCH_THRESHOLD_LOG;if(void 0!==t.start||void 0!==t.end){var n=this._playerUtil.getRangeOfVariant(r);void 0!==n&&void 0!==t.start&&Math.abs(n.start-t.start)>i&&this._system.logWarn("Period '".concat(t.id,"' mismatch start compared to variant. Period starts at ").concat(t.start," with variant starting at ").concat(n.start)),void 0!==n&&void 0!==t.end&&Math.abs(n.end-t.end)>i&&this._system.logWarn("Period '".concat(t.id,"' mismatch end compared to variant. Period ends at ").concat(t.end," with variant ending at ").concat(n.end))}},e.prototype._ensureMediaKeys=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:if(void 0===this.drm||void 0!==this.drm.getChosenMediaKeyOptions())return[2];return[4,this.selectAllVariants()];case 1:return e=t.sent(),[4,this.drm.chooseMediaKeyOption(e)];case 2:return void 0!==t.sent().mediaKeys&&(this._system.logVerbose("Invalidating all variants due to new media keys being created"),this.invalidateAllVariants(["Digital Rights Variant Filter"])),[2]}})})},e.INITIAL_NAME="Initial",e.PERIOD_RANGE_MISMATCH_THRESHOLD_LOG=.5,e.DEFAULT_AUDIO_PREFERENCE={streamType:"audio",attributes:0},e.DEFAULT_VIDEO_PREFERENCE={streamType:"video",attributes:0},e.DEFAULT_TEXT_PREFERENCE={streamType:"text",attributes:0},e}();t.BufferController=L}}]);
//# sourceMappingURL=lib-2dc1189d-e3f2c5e576e639d0.js.map